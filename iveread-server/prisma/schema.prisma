// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* User & Friendship */
model User {
	id            String    @id @default(uuid()) // Primary Key
	email         String    @unique
	password      String
	nickname      String
	emoji         String?
	
	followedBy    Friendship[] @relation("following")
	following     Friendship[] @relation("follower")
	
	groups            GroupMember[]
	records           ReadingRecord[]
	sentences         Sentence[]
	sentenceComments  Comment[]
	recordComments    RecordComment[]
	likes             Like[]
	reactions         RecordReaction[]
	attendances       Attendance[]
}

// Junction Table
model Friendship {
	followerId    String
	followingId   String

	createdAt     DateTime @default(now())
	
	follower      User     @relation("follower", fields: [followerId], references: [id])
	following     User     @relation("following", fields: [followingId], references: [id])
	
	@@id([followerId, followingId]) // Primary Key	
}

/* Book */
model Book {
	isbn          String   @id // Primary Key
	title         String
	author        String
	publisher     String
	coverImage    String
	totalPage     Int?
	
	groups        Group[]
	records       ReadingRecord[]
	sentences     Sentence[]
}

/* Group */
model Group {
	id           String      @id @default(uuid()) // Primary Key
	name         String
	startDate    DateTime
	goalDate     DateTime?
	
	bookIsbn     String
	book         Book        @relation(fields: [bookIsbn], references: [isbn])
	
	members      GroupMember[]
	sentences    Sentence[]
	records      ReadingRecord[]
	attendances  Attendance[]
	
	createdAt    DateTime @default(now())
}

// Junction Table
model GroupMember {
	userId        String
	groupId       String
	
	user          User        @relation(fields: [userId], references: [id])
	group         Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)
	
	// Reading Progress
	lastReadPage  Int       @default(0)
	isFinished    Boolean   @default(false)
	
	@@id([userId, groupId]) // Primary Key
}

/* Reading Record (for gallery & Calendar) */
model ReadingRecord {
	id              String    @id @default(uuid()) // Primary Key
	readDate        DateTime
	startPage       Int
	endPage         Int
	comment         String?
	imageUrl        String
	
	userId          String
	bookIsbn        String
	groupId         String
	
	user            User     @relation(fields: [userId], references: [id])
	book            Book     @relation(fields: [bookIsbn], references: [isbn])
	group           Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
	
	reactions       RecordReaction[]
	recordComments  RecordComment[]
	likes           Like[]

	createdAt       DateTime @default(now())
}

/* Sentence chosen by user */
model Sentence {
	id            String    @id @default(uuid()) // Primary Key
	content       String    @db.Text
    pageNo        Int
    thought       String?   @db.Text

	userId        String
	groupId       String
	bookIsbn      String
	
	user          User     @relation(fields: [userId], references: [id])
	group         Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
	book          Book     @relation(fields: [bookIsbn], references: [isbn])
	
	comments      Comment[]
	
	createdAt     DateTime @default(now())
}

/* Comment for the sentence */
model Comment {
	id            String    @id @default(uuid()) // Primary Key
	content       String    @db.Text
	
    userId        String
    sentenceId    String
    
    user          User      @relation(fields: [userId], references: [id]) 
    sentence      Sentence  @relation(fields: [sentenceId], references: [id], onDelete: Cascade)

	createdAt     DateTime  @default(now())
}

/* Reaction for the record */
model RecordReaction {
	id            String    @id @default(uuid()) // Primary Key
	emoji         String
	
	userId        String
	recordId      String
	
	user          User           @relation(fields: [userId], references: [id])
	record        ReadingRecord  @relation(fields: [recordId], references: [id], onDelete: Cascade)

	createdAt     DateTime  @default(now())
	
	@@unique([userId, recordId])
}

/* Comment for the reading record */
model RecordComment {
	id            String          @id @default(uuid()) // Primary Key
	content       String          @db.Text
	
    userId        String
    recordId      String
  
    user          User            @relation(fields: [userId], references: [id])
    record        ReadingRecord   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
	createdAt     DateTime  @default(now())
}

/* Like for the reading record */
model Like {
	userId        String    
	recordId      String
	
	user          User            @relation(fields: [userId], references: [id])
    record        ReadingRecord   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
	createdAt     DateTime  @default(now())
	
	@@id([userId, recordId]) // Primary Key
}

/* Attendance */
model Attendance {
	id            String   @id @default(uuid()) // Primary Key
	date          DateTime @default(now()) @db.Date
	
	userId        String
	groupId       String
	
	user          User     @relation(fields: [userId], references: [id])
	group         Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
	
	@@unique([userId, groupId, date])
}